// This generates the files in the "src/configs" directory.

import type { TSESLint } from "@typescript-eslint/utils";
import { writeFile } from "isaacscript-common-node";
import path from "node:path";
import { PACKAGE_ROOT } from "./constants.js";
import type { RuleDefinition } from "./utils.js";
import {
  formatWithPrettier,
  getAutoGeneratedComment,
  getRuleEntries,
  getRuleNameWithPluginNamePrefix,
  isRecommendedRule,
} from "./utils.js";

type LinterConfigRules = Record<
  string,
  TSESLint.Linter.RuleLevel | TSESLint.Linter.RuleLevelAndOptions
>;

export const CONFIGS_DIRECTORY_PATH = path.join(PACKAGE_ROOT, "src", "configs");

const BASE_CONFIG = [
  // The main config object.
  {
    // The "plugins" property is populated in the "index.ts" file.
    plugins: {},

    rules: {
      // The ESLint "eqeqeq" rule will conflict with the "isaacscript/eqeqeq-fix" rule.
      eqeqeq: "off",

      // The ESLint "no-template-curly-in-string" rule will conflict with the
      // "isaacscript/no-template-curly-in-string-fix" rule.
      "no-template-curly-in-string": "off",
    },
  },

  // Disable some TypeScript-specific rules in JavaScript files.
  {
    files: ["*.js", "*.cjs", "*.mjs", "*.jsx"],
    rules: {
      "isaacscript/no-let-any": "off",
      "isaacscript/no-object-any": "off",
      "isaacscript/require-capital-const-assertions": "off",
      "isaacscript/require-capital-read-only": "off",
    },
  },
] as const satisfies TSESLint.FlatConfig.ConfigArray;

export async function generateConfigs(): Promise<void> {
  await recommended();
}

async function recommended() {
  const ruleEntries = await getRuleEntries();
  const recommendedRules = ruleEntries
    .filter((entry) => isRecommendedRule(entry[1]))
    // eslint-disable-next-line unicorn/no-array-reduce
    .reduce<LinterConfigRules>((config, entry) => reducer(config, entry), {});

  const rules = BASE_CONFIG[0].rules as Record<string, unknown>;
  for (const [ruleName, level] of Object.entries(recommendedRules)) {
    rules[ruleName] = level;
  }

  await writeConfig("recommended", BASE_CONFIG);
}

async function writeConfig(
  name: string,
  config: TSESLint.FlatConfig.ConfigArray,
) {
  const comment = getAutoGeneratedComment();
  const code = `import { TSESLint } from "@typescript-eslint/utils";\n\nexport const ${name}: TSESLint.FlatConfig.ConfigArray = ${JSON.stringify(config)};`;
  const combined = comment + code;
  const content = await formatWithPrettier(combined, "typescript");

  const fileName = `${name}.ts`;
  const filePath = path.join(CONFIGS_DIRECTORY_PATH, fileName);
  writeFile(filePath, content);
}

/** Reduces records to key/value pairs. */
function reducer(
  config: LinterConfigRules,
  entry: [string, RuleDefinition],
): LinterConfigRules {
  const [ruleName] = entry;
  const fullRuleName = getRuleNameWithPluginNamePrefix(ruleName);
  config[fullRuleName] = "error";

  return config;
}
